"""
–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ ML –º–æ–¥–µ–ª–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Softclub
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ 6 –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ + –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
"""
import pandas as pd
import numpy as np
from sklearn.metrics import (
    accuracy_score, 
    precision_score, 
    recall_score, 
    f1_score,
    roc_auc_score,
    confusion_matrix,
    classification_report
)
import xgboost as xgb

def evaluate_model():
    print("=" * 80)
    print("üìä –ö–û–ú–ü–õ–ï–ö–°–ù–ê–Ø –û–¶–ï–ù–ö–ê ML –ú–û–î–ï–õ–ò")
    print("=" * 80)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å
    print("\nüì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...")
    model = xgb.Booster()
    model.load_model('models/trained/churn_model.json')
    print("   ‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    print("\nüìä –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")
    df = pd.read_csv('data/training_data_balanced.csv')
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º 20% –∫–∞–∫ —Ç–µ—Å—Ç (—Å —Ç–µ–º –∂–µ random_state)
    from sklearn.model_selection import train_test_split
    
    feature_names = [
        'attendance_rate',
        'homework_completion',
        'test_avg_score',
        'communication_activity',
        'days_enrolled',
        'missed_classes_streak'
    ]
    
    X = df[feature_names].values
    y = df['churned'].values
    
    _, X_test, _, y_test = train_test_split(
        X, y, test_size=0.2, random_state=42, stratify=y
    )
    
    print(f"   ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(X_test)} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤")
    print(f"      - Active (churned=0): {(y_test == 0).sum()}")
    print(f"      - Churned (churned=1): {(y_test == 1).sum()}")
    
    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
    print("\nüîÆ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π...")
    dtest = xgb.DMatrix(X_test, feature_names=feature_names)
    y_pred_proba = model.predict(dtest)
    y_pred = (y_pred_proba >= 0.5).astype(int)
    
    # ============================================================
    # –ú–ï–¢–†–ò–ö–ê 1: ACCURACY (–¢–æ—á–Ω–æ—Å—Ç—å)
    # ============================================================
    accuracy = accuracy_score(y_test, y_pred)
    
    print("\n" + "=" * 80)
    print("1Ô∏è‚É£  ACCURACY (–¢–æ—á–Ω–æ—Å—Ç—å)")
    print("=" * 80)
    print(f"üìà –ó–Ω–∞—á–µ–Ω–∏–µ: {accuracy:.4f} ({accuracy*100:.2f}%)")
    print("\nüí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:")
    print("   Accuracy = (TP + TN) / (TP + TN + FP + FN)")
    print("   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –ö–∞–∫–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—Å–µ—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –ü–†–ê–í–ò–õ–¨–ù–´–ô")
    print(f"\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ú–æ–¥–µ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª–∞ {accuracy*100:.2f}% —Å—Ç—É–¥–µ–Ω—Ç–æ–≤")
    
    # ============================================================
    # –ú–ï–¢–†–ò–ö–ê 2: PRECISION (–¢–æ—á–Ω–æ—Å—Ç—å –¥–ª—è churned)
    # ============================================================
    precision = precision_score(y_test, y_pred)
    
    print("\n" + "=" * 80)
    print("2Ô∏è‚É£  PRECISION (–¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π '–û—Ç—á–∏—Å–ª–∏—Ç—Å—è')")
    print("=" * 80)
    print(f"üìà –ó–Ω–∞—á–µ–Ω–∏–µ: {precision:.4f} ({precision*100:.2f}%)")
    print("\nüí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:")
    print("   Precision = TP / (TP + FP)")
    print("   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –ö–æ–≥–¥–∞ –º–æ–¥–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç '–û–¢–ß–ò–°–õ–ò–¢–°–Ø', –∫–∞–∫ —á–∞—Å—Ç–æ —ç—Ç–æ –ü–†–ê–í–î–ê?")
    print(f"\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ò–∑ –≤—Å–µ—Ö –∫–æ–≥–æ –º–æ–¥–µ–ª—å –Ω–∞–∑–≤–∞–ª–∞ '–æ—Ç—á–∏—Å–ª–∏—Ç—Å—è',")
    print(f"   {precision*100:.2f}% —Ä–µ–∞–ª—å–Ω–æ –æ—Ç—á–∏—Å–ª–∏–ª–∏—Å—å")
    
    # ============================================================
    # –ú–ï–¢–†–ò–ö–ê 3: RECALL (–ü–æ–ª–Ω–æ—Ç–∞ –¥–ª—è churned)
    # ============================================================
    recall = recall_score(y_test, y_pred)
    
    print("\n" + "=" * 80)
    print("3Ô∏è‚É£  RECALL (–ü–æ–ª–Ω–æ—Ç–∞ - –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –î–õ–Ø –ë–ò–ó–ù–ï–°–ê!)")
    print("=" * 80)
    print(f"üìà –ó–Ω–∞—á–µ–Ω–∏–µ: {recall:.4f} ({recall*100:.2f}%)")
    print("\nüí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:")
    print("   Recall = TP / (TP + FN)")
    print("   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –°–∫–æ–ª—å–∫–æ –†–ï–ê–õ–¨–ù–´–• –æ—Ç—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –º—ã –ù–ê–®–õ–ò?")
    print(f"\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ú–æ–¥–µ–ª—å –Ω–∞—à–ª–∞ {recall*100:.2f}% –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤,")
    print(f"   –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –æ—Ç—á–∏—Å–ª–∏–ª–∏—Å—å")
    print("\n‚ö†Ô∏è  –≠–¢–û –ì–õ–ê–í–ù–û–ï! –ß–µ–º –≤—ã—à–µ Recall, —Ç–µ–º –º–µ–Ω—å—à–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ '—É–ø—É—Å—Ç–∏–º'")
    
    # ============================================================
    # –ú–ï–¢–†–ò–ö–ê 4: F1-SCORE (–ë–∞–ª–∞–Ω—Å Precision –∏ Recall)
    # ============================================================
    f1 = f1_score(y_test, y_pred)
    
    print("\n" + "=" * 80)
    print("4Ô∏è‚É£  F1-SCORE (–ë–∞–ª–∞–Ω—Å)")
    print("=" * 80)
    print(f"üìà –ó–Ω–∞—á–µ–Ω–∏–µ: {f1:.4f} ({f1*100:.2f}%)")
    print("\nüí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:")
    print("   F1 = 2 * (Precision * Recall) / (Precision + Recall)")
    print("   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –ø–æ–ª–Ω–æ—Ç–æ–π")
    print(f"\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: F1={f1*100:.2f}% - {'–û–¢–õ–ò–ß–ù–û' if f1 > 0.9 else '–•–û–†–û–®–û' if f1 > 0.8 else '–ù–û–†–ú–ê–õ–¨–ù–û'}")
    
    # ============================================================
    # –ú–ï–¢–†–ò–ö–ê 5: ROC-AUC (–ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è)
    # ============================================================
    roc_auc = roc_auc_score(y_test, y_pred_proba)
    
    print("\n" + "=" * 80)
    print("5Ô∏è‚É£  ROC-AUC (–ö–∞—á–µ—Å—Ç–≤–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π)")
    print("=" * 80)
    print(f"üìà –ó–Ω–∞—á–µ–Ω–∏–µ: {roc_auc:.4f} ({roc_auc*100:.2f}%)")
    print("\nüí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:")
    print("   ROC-AUC –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –º–æ–¥–µ–ª—å —Ä–∞–∑–¥–µ–ª—è–µ—Ç –∫–ª–∞—Å—Å—ã")
    print("   1.0 = –∏–¥–µ–∞–ª—å–Ω–æ, 0.5 = —Å–ª—É—á–∞–π–Ω–æ–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ")
    print(f"\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: ROC-AUC={roc_auc*100:.2f}% - {'–û–¢–õ–ò–ß–ù–û' if roc_auc > 0.95 else '–•–û–†–û–®–û' if roc_auc > 0.85 else '–ù–û–†–ú–ê–õ–¨–ù–û'}")
    
    # ============================================================
    # –ú–ï–¢–†–ò–ö–ê 6: CONFUSION MATRIX (–ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫)
    # ============================================================
    cm = confusion_matrix(y_test, y_pred)
    tn, fp, fn, tp = cm.ravel()
    
    print("\n" + "=" * 80)
    print("6Ô∏è‚É£  CONFUSION MATRIX (–ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫)")
    print("=" * 80)
    print(f"\n                    –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–æ")
    print(f"                Active    Churned")
    print(f"–†–µ–∞–ª—å–Ω–æ  Active    {tn:4d}      {fp:4d}")
    print(f"         Churned   {fn:4d}      {tp:4d}")
    print("\nüí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:")
    print(f"   TN (True Negative)  = {tn:4d} - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª–∏ '–æ—Å—Ç–∞–Ω–µ—Ç—Å—è'")
    print(f"   FP (False Positive) = {fp:4d} - –û—à–∏–±–æ—á–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª–∏ '–æ—Ç—á–∏—Å–ª–∏—Ç—Å—è'")
    print(f"   FN (False Negative) = {fn:4d} - –ü–†–û–ü–£–°–¢–ò–õ–ò –æ—Ç—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ! ‚ùå")
    print(f"   TP (True Positive)  = {tp:4d} - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª–∏ '–æ—Ç—á–∏—Å–ª–∏—Ç—Å—è' ‚úÖ")
    
    # ============================================================
    # –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê
    # ============================================================
    print("\n" + "=" * 80)
    print("üìä –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê –ú–û–î–ï–õ–ò")
    print("=" * 80)
    print(f"\n1Ô∏è‚É£  Accuracy:  {accuracy*100:6.2f}% - –û–±—â–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å")
    print(f"2Ô∏è‚É£  Precision: {precision*100:6.2f}% - –¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π '–æ—Ç—á–∏—Å–ª–∏—Ç—Å—è'")
    print(f"3Ô∏è‚É£  Recall:    {recall*100:6.2f}% ‚≠ê –ù–∞—à–ª–∏ —Å—Ç–æ–ª—å–∫–æ –æ—Ç—á–∏—Å–ª–µ–Ω–Ω—ã—Ö")
    print(f"4Ô∏è‚É£  F1-Score:  {f1*100:6.2f}% - –ë–∞–ª–∞–Ω—Å")
    print(f"5Ô∏è‚É£  ROC-AUC:   {roc_auc*100:6.2f}% - –ö–∞—á–µ—Å—Ç–≤–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π")
    print(f"6Ô∏è‚É£  –û—à–∏–±–æ–∫:    {fp + fn} –∏–∑ {len(y_test)} ({(fp + fn)/len(y_test)*100:.2f}%)")
    
    print("\nüéØ –ë–ò–ó–ù–ï–° –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø:")
    print(f"   ‚úÖ –ú–æ–¥–µ–ª—å –Ω–∞–π–¥–µ—Ç {recall*100:.1f}% —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç—á–∏—Å–ª—è—Ç—Å—è")
    print(f"   ‚ö†Ô∏è  –ü—Ä–æ–ø—É—Å—Ç–∏–º {fn} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–æ–Ω–∏ –æ—Ç—á–∏—Å–ª—è—Ç—Å—è, –Ω–æ –º—ã –Ω–µ —É–∑–Ω–∞–µ–º)")
    print(f"   ‚ö†Ô∏è  –û—à–∏–±–æ—á–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–º {fp} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–æ–Ω–∏ –Ω–µ –æ—Ç—á–∏—Å–ª—è—Ç—Å—è)")
    
    print("\n" + "=" * 80)
    print("‚úÖ –û–¶–ï–ù–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê")
    print("=" * 80)


if __name__ == "__main__":
    evaluate_model()
